# Configuration principale du portfolio

server {
    listen 80;
    server_name localhost;  # À remplacer par votre domaine

    # Logs spécifiques
    access_log /var/log/nginx/portfolio_access.log;
    error_log /var/log/nginx/portfolio_error.log;

    # Headers de sécurité
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Taille max des uploads (formulaire de contact avec pièces jointes)
    client_max_body_size 10M;

    # ============================
    # BACKEND API
    # ============================
    location /api/ {
        # Rate limiting sur l'API
        limit_req zone=api_limit burst=20 nodelay;

        # FastCGI vers le backend PHP-FPM
        fastcgi_pass backend:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/backend/public/index.php;
        fastcgi_param REQUEST_URI $request_uri;
        include fastcgi_params;
        
        # Headers
        fastcgi_param HTTP_X_REAL_IP $remote_addr;
        fastcgi_param HTTP_X_FORWARDED_FOR $proxy_add_x_forwarded_for;
        fastcgi_param HTTP_X_FORWARDED_PROTO $scheme;

        # Timeouts
        fastcgi_connect_timeout 60s;
        fastcgi_send_timeout 60s;
        fastcgi_read_timeout 60s;

        # CORS (si nécessaire pour tests locaux)
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;

        # Préflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Rate limiting encore plus strict pour le formulaire de contact
    location /api/contact {
        limit_req zone=contact_limit burst=3 nodelay;
        
        fastcgi_pass backend:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/backend/public/index.php;
        fastcgi_param REQUEST_URI /api/contact;
        include fastcgi_params;
    }

    # ============================
    # FRONTEND STATIQUE
    # ============================
    location / {
        root /var/www/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;

        # Cache pour les assets statiques
        location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location ~* \.(css|js)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Ne pas cacher le HTML (pour les mises à jour)
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    # ============================
    # SÉCURITÉ
    # ============================
    
    # Bloquer l'accès aux fichiers cachés
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Bloquer l'accès aux fichiers sensibles
    location ~ \.(env|yml|yaml|log|ini|json|lock)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Health check (pour monitoring)
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}

# Configuration HTTPS (à activer après obtention du certificat SSL)
# Décommenter après avoir obtenu les certificats via Cloudflare ou Let's Encrypt
#
# server {
#     listen 443 ssl http2;
#     server_name votredomaine.fr www.votredomaine.fr;
#
#     ssl_certificate /etc/nginx/ssl/fullchain.pem;
#     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # Reprendre la configuration ci-dessus
#     # ...
# }
#
# # Redirection HTTP vers HTTPS
# server {
#     listen 80;
#     server_name votredomaine.fr www.votredomaine.fr;
#     return 301 https://$server_name$request_uri;
# }
