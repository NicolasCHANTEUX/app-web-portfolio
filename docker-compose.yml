version: '3.8'

services:
  # Reverse Proxy - Le portier qui route tout
  nginx:
    image: nginx:alpine
    container_name: portfolio_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend/dist:/var/www/frontend:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - backend
    networks:
      - portfolio_network
    restart: unless-stopped

  # Backend PHP - L'API pour les stats et interactions
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: portfolio_backend
    volumes:
      - ./backend/public:/var/www/backend/public
      - ./backend/src:/var/www/backend/src
      - ./backend/database:/var/www/backend/database
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Pour monitorer les conteneurs
      - /sys/class/thermal:/sys/class/thermal:ro  # Accès aux capteurs de température (Linux uniquement)
    environment:
      - DB_HOST=mariadb
      - DB_NAME=portfolio_db
      - DB_USER=portfolio_user
      - DB_PASSWORD=ChangeMeInProduction123!
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - CONTACT_EMAIL=${CONTACT_EMAIL}
    depends_on:
      - mariadb
    networks:
      - portfolio_network
    restart: unless-stopped

  # Base de données - Pour stocker les messages de contact et analytics
  mariadb:
    image: mariadb:10.11
    container_name: portfolio_mariadb
    environment:
      - MYSQL_ROOT_PASSWORD=RootPassword123!ChangeMeInProduction
      - MYSQL_DATABASE=portfolio_db
      - MYSQL_USER=portfolio_user
      - MYSQL_PASSWORD=ChangeMeInProduction123!
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./backend/database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - portfolio_network
    restart: unless-stopped

  # Frontend Build (optionnel - pour rebuild Astro automatiquement en dev)
  frontend_dev:
    image: node:20-alpine
    container_name: portfolio_frontend_dev
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "4321:4321"  # Port de dev Astro
    networks:
      - portfolio_network
    profiles:
      - dev  # Ce conteneur ne démarre qu'avec: docker-compose --profile dev up

networks:
  portfolio_network:
    driver: bridge

volumes:
  mariadb_data:
    driver: local
